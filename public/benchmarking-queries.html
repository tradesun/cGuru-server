<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Benchmarking Queries</title>
  <link rel="icon" href="/images/CHG_Logo_200.png">
  <link rel="stylesheet" href="/styles.css">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; margin: 0; padding: 24px; color: #0f172a; background: #f8fafc; }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { font-size: 22px; margin: 4px 0 18px; }
    .section { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 18px; margin-bottom: 16px; }
    .desc { color: #334155; font-size: 14px; margin: 8px 0 12px; }
    details { border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 12px; background: #f8fafc; }
    summary { font-weight: 600; cursor: pointer; }
    pre { overflow: auto; background: #0b1020; color: #e2e8f0; padding: 12px; border-radius: 6px; font-size: 12px; line-height: 1.45; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; font-size: 14px; }
    th { background: #f1f5f9; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #ecfeff; color: #155e75; font-weight: 600; font-size: 12px; border: 1px solid #cffafe; }
    .filters { display: flex; gap: 12px; align-items: center; margin-top: 6px; }
    select { padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 6px; background: #fff; }
    button { padding: 7px 12px; border: 1px solid #0ea5e9; background: #0ea5e9; color: #fff; border-radius: 6px; cursor: pointer; }
    button.secondary { background: #fff; color: #0ea5e9; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Benchmarking Queries</h1>

    <!-- Query 1: Static list of total scores per user -->
    <div class="section">
      <div class="pill">Query 1</div>
      <h3 style="margin:8px 0 6px;font-size:16px;">Total scores for all users (latest per assessment)</h3>
      <p class="desc">For each user, use the latest submission per assessment, then average across assessments to get the user's total score. Includes profile attributes.</p>
      <details>
        <summary>Show SQL</summary>
        <pre>WITH latest_per_assessment AS (
  SELECT
    s.email,
    s.assessment_id,
    s.total_percent,
    ROW_NUMBER() OVER (
      PARTITION BY s.email, s.assessment_id
      ORDER BY s.finished_at DESC, s.id DESC
    ) AS rn
  FROM submissions s
)
SELECT
  l.email,
  ROUND(AVG(l.total_percent))      AS total_score_percent,
  COUNT(*)                         AS assessments_count,
  MAX(p.size)                      AS size,
  MAX(p.country)                   AS country,
  MAX(p.region)                    AS region,
  MAX(p.location)                  AS location
FROM latest_per_assessment l
LEFT JOIN profile p
  ON p.email = l.email
WHERE l.rn = 1
GROUP BY l.email
ORDER BY l.email;</pre>
      </details>

      <table id="resultsTable1">
        <thead>
          <tr>
            <th>email</th>
            <th>total_score_percent</th>
            <th>assessments_count</th>
            <th>size</th>
            <th>country</th>
            <th>region</th>
            <th>location</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Query 2: Dynamic list filtered by size range and country -->
    <div class="section">
      <div class="pill">Query 2</div>
      <h3 style="margin:8px 0 6px;font-size:16px;">Filtered users by size range and country</h3>
      <p class="desc">Shows total scores for users where company size is within the selected range and matches the selected country.</p>
      <details>
        <summary>Show SQL</summary>
        <pre id="sqlBlock2"></pre>
      </details>

      <div class="filters">
        <label>Size:
          <select id="sizeSelect2">
            <option value="">All</option>
            <option value="1-4">1-4</option>
            <option value="5-9">5-9</option>
            <option value="10-14">10-14</option>
            <option value="15-29">15-29</option>
            <option value="30-50">30-50</option>
          </select>
        </label>
        <label>Country:
          <select id="countrySelect2">
            <option value="">Global</option>
          </select>
        </label>
        <button id="applyBtn2">Apply</button>
        <button class="secondary" id="resetBtn2">Reset</button>
      </div>

      <table id="resultsTable2" style="display:none;">
        <thead>
          <tr>
            <th>email</th>
            <th>total_score_percent</th>
            <th>assessments_count</th>
            <th>size</th>
            <th>country</th>
            <th>region</th>
            <th>location</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="aggBox" class="sidebar-summary" style="margin-top:12px;">
        <div class="item"><span class="label">Average total score</span><span class="value" id="aggAvg">-</span></div>
        <div class="item"><span class="label">Users count</span><span class="value" id="aggCount">-</span></div>
      </div>

      <div class="section" style="margin-top:16px;">
        <h4 style="margin:0 0 8px;">Per assessment averages</h4>
        <details>
          <summary>Show SQL</summary>
          <pre id="sqlBlock2b"></pre>
        </details>
        <table id="perAssessmentTable">
          <thead>
            <tr>
              <th>assessment_id</th>
              <th>avg_total_score_percent</th>
              <th>users_count</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="/js/benchmarking.js"></script>
</body>
<style>
  span#aggAvg, #aggCount {
    margin-left: 17px;
    display: inline-block;
    font-weight: 700;
}
</style>
</html>